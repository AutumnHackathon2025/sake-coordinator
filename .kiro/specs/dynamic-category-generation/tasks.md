# 実装タスクリスト: 推薦カテゴリーの動的生成

## 実装方針

- 既存のRecommendationServiceとモデルを更新
- プロンプト構築ロジックを変更してカテゴリー動的生成を指示
- レスポンスパース処理を更新して動的カテゴリーを抽出
- 既存テストを更新して動的カテゴリーに対応
- 後方互換性を維持（APIレスポンス形式は変更なし）

## タスク一覧

- [x] 1. Recommendationモデルの更新
  - categoryフィールドのバリデーションを固定値から動的文言に変更
  - 文字数バリデーション（1-10文字）を追加
  - バリデーターで空文字列チェックを追加
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 1.1 categoryフィールドの型変更
  - Literal["次の一手", "運命の出会い"]からstr型に変更
  - Field(..., min_length=1, max_length=10)を設定
  - _要件: 3.1, 3.2_

- [x] 1.2 カスタムバリデーターの追加
  - @validator('category')デコレーターを追加
  - 空文字列チェックを実装
  - 文字数チェックを実装
  - 日本語エラーメッセージを設定
  - _要件: 3.3, 3.5_

- [x] 2. RecommendationService._build_recommendation_prompt()の更新
  - プロンプトにカテゴリー動的生成の指示を追加
  - カテゴリー名の例を提示
  - 文字数制限（1-10文字）を明示
  - best_recommendにカテゴリーを含めないことを明示
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 2.1 プロンプトテンプレートの更新
  - カテゴリー分類セクションを更新
  - 動的カテゴリー生成のルールを追加
  - カテゴリー名の例を追加（「新しい挑戦」「好みに近い」等、10文字以内）
  - _要件: 2.1, 2.2_

- [x] 2.2 レスポンス形式の指示を更新
  - best_recommendにcategoryフィールドを含めない
  - recommendationsにcategoryフィールドを含める
  - JSON形式の例を更新
  - _要件: 2.4, 2.5_

- [x] 3. RecommendationService._parse_recommendations()の更新
  - 動的カテゴリーの抽出処理を実装
  - カテゴリーのバリデーション処理を追加
  - デフォルトカテゴリーのフォールバック処理を追加
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [x] 3.1 best_recommendの抽出処理を確認
  - categoryフィールドが含まれていないことを確認
  - 既存のフィールド（brand, brand_description等）を抽出
  - _要件: 4.1, 4.2_

- [x] 3.2 recommendationsの抽出処理を更新
  - categoryフィールドを抽出
  - カテゴリーの文字数バリデーション（1-10文字）
  - 無効なカテゴリーの場合はデフォルト値（「おすすめ」）を設定
  - ログ記録を追加
  - _要件: 4.3, 4.4, 4.5, 4.6_

- [-] 4. ユニットテストの更新
  - 動的カテゴリーのテストケースを追加
  - 固定値のアサーションを削除
  - カテゴリー文字数のテストを追加
  - 無効なカテゴリーのハンドリングをテスト
  - _要件: 5.1, 5.3, 5.4, 5.5_

- [x] 4.1 test_parse_recommendations_with_dynamic_category()の追加
  - 動的カテゴリーが正しくパースされることを確認
  - カテゴリーが1-10文字の範囲内であることを確認
  - best_recommendにcategoryフィールドが含まれないことを確認
  - _要件: 5.1, 5.4, 5.5_

- [x] 4.2 test_parse_recommendations_with_invalid_category()の追加
  - 空文字列のカテゴリーをテスト
  - 10文字超過のカテゴリーをテスト
  - デフォルトカテゴリー（「おすすめ」）が設定されることを確認
  - _要件: 5.1, 5.4_

- [x] 4.3 既存テストの更新
  - 固定値（「次の一手」「運命の出会い」）のアサーションを削除
  - カテゴリーが文字列であることを確認
  - カテゴリーが1-10文字の範囲内であることを確認
  - _要件: 5.3, 5.4_

- [x] 5. 統合テストの更新
  - Bedrockが動的カテゴリーを生成することを確認
  - エンドツーエンドでの動作確認
  - _要件: 5.2_

- [x] 5.1 test_generate_recommendations_with_dynamic_category()の追加
  - 実際のBedrock呼び出しで動的カテゴリーが生成されることを確認
  - カテゴリーが固定値でないことを確認
  - カテゴリーが1-10文字の範囲内であることを確認
  - _要件: 5.2, 5.4_

- [x] 5.2 既存の統合テストを更新
  - 固定値のアサーションを削除
  - 動的カテゴリーのアサーションを追加
  - _要件: 5.2, 5.3_

- [x] 6. ドキュメントの更新
  - README.mdにカテゴリー動的生成の説明を追加
  - レスポンス例を更新
  - カテゴリー名の例を記載
  - _要件: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 6.1 README.mdの更新
  - 推薦カテゴリーセクションを追加
  - カテゴリー名の例を記載（10文字以内）
  - 文字数制限（1-10文字）を記載
  - best_recommendにカテゴリーが含まれないことを記載
  - _要件: 7.1, 7.2, 7.3, 7.4_

- [x] 6.2 レスポンス例の更新
  - 動的カテゴリーを含むレスポンス例を追加
  - best_recommendにcategoryフィールドが含まれないことを示す
  - recommendationsに動的カテゴリーが含まれることを示す
  - _要件: 7.5_

- [x] 7. 動作確認とテスト実行
  - 全テストを実行して成功を確認
  - ローカル環境で動作確認
  - レスポンスが期待通りであることを確認
  - _要件: 全要件_

- [x] 7.1 ユニットテストの実行
  - pytest agentcore/tests/test_models.pyを実行
  - pytest agentcore/tests/test_recommendation_service.pyを実行
  - 全テストが成功することを確認
  - _要件: 全要件_

- [x] 7.2 統合テストの実行
  - pytest agentcore/tests/test_recommendation_integration.pyを実行
  - Bedrockが動的カテゴリーを生成することを確認
  - _要件: 全要件_

- [x] 7.3 ローカル環境での動作確認
  - Docker Composeで環境を起動
  - POST /agent/recommendエンドポイントを呼び出し
  - レスポンスのカテゴリーが動的に生成されていることを確認
  - カテゴリーが1-10文字の範囲内であることを確認
  - _要件: 全要件_

## 実装の注意点

### 後方互換性の維持

- APIレスポンス形式は変更しない
- best_recommendの構造は変更しない（categoryフィールドは元々含まれていない）
- recommendationsの構造は変更しない（categoryフィールドの型のみ変更）
- エラーハンドリングは既存のまま維持

### カテゴリーのフォールバック

無効なカテゴリー（空文字列、10文字超過）の場合は、デフォルト値「おすすめ」を設定してエラーを回避します。

### テストの更新

固定値（「次の一手」「運命の出会い」）のアサーションを削除し、動的な文言であることを確認するテストに更新します。

### ログ記録

カテゴリーが無効な場合は警告ログを記録し、デバッグを容易にします。
