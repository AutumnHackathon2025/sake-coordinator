# 実装計画

- [x] 1. Terraformプロジェクト構造とベース設定の作成
  - infrastructureディレクトリ構造を作成
  - main.tf、variables.tf、outputs.tfのベースファイルを作成
  - AWS Provider 6.18.0の設定
  - 共通タグとプロジェクト変数の定義
  - _要件: 1.1, 7.1, 7.2, 7.3_

- [x] 2. ネットワーキングモジュールの実装
- [x] 2.1 VPCとサブネット構成の作成
  - VPC（10.0.0.0/16）の作成
  - パブリックサブネット×2（各AZ）の作成
  - プライベートサブネット×2（各AZ）の作成
  - インターネットゲートウェイの作成
  - _要件: 1.2_

- [x] 2.2 ルーティングとNATゲートウェイの設定
  - NATゲートウェイ×2（各AZ）の作成
  - ルートテーブルの作成と関連付け
  - Elastic IPの割り当て
  - _要件: 1.2_

- [x] 3. セキュリティモジュールの実装
- [x] 3.1 セキュリティグループの作成
  - ALB用セキュリティグループ（HTTP/HTTPS許可）
  - ECS用セキュリティグループ（ALBからのアクセス許可）
  - VPCエンドポイント用セキュリティグループ
  - _要件: 1.4_

- [x] 3.2 IAMロールとポリシーの作成
  - ECSタスク実行ロール
  - ECSタスクロール（S3、DynamoDB、Cognitoアクセス用）
  - Cognito認証済み/未認証ユーザーロール
  - _要件: 2.4, 3.4, 4.5, 5.5_

- [x] 4. コンピューティングモジュールの実装
- [x] 4.1 ECRリポジトリの作成
  - Next.jsアプリケーション用ECRリポジトリ
  - ライフサイクルポリシーの設定
  - _要件: 2.2_

- [x] 4.2 Application Load Balancerの設定
  - ALBの作成とHTTPS終端設定
  - ターゲットグループの作成
  - リスナールールの設定
  - _要件: 1.3_

- [x] 4.3 ECSクラスターとサービスの作成
  - ECS Fargateクラスターの作成
  - ECSタスク定義（CPU: 512、メモリ: 1024MB）
  - ECSサービスの作成
  - _要件: 2.1, 2.3_

- [x] 4.4 オートスケーリング設定の実装
  - ECSサービスのオートスケーリング設定
  - CPU使用率70%でのスケールアウト設定
  - 最小タスク数2、最大タスク数10の設定
  - _要件: 2.5_

- [x] 5. 認証モジュールの実装
- [x] 5.1 Cognitoユーザープールの作成
  - ユーザープールの作成
  - Passkey（WebAuthn/FIDO2）認証の有効化
  - メール検証の有効化
  - パスワードレス認証の設定
  - _要件: 3.1, 3.3_

- [x] 5.2 Cognitoユーザープールクライアントの設定
  - Next.jsアプリケーション用クライアントの作成
  - JWT設定とトークン有効期限の設定
  - WebAuthn設定とPasskey対応
  - 生体認証とセキュリティキーサポートの設定
  - _要件: 3.2, 3.3_

- [x] 5.3 Cognitoアイデンティティプールの作成
  - アイデンティティプールの作成
  - 認証済み/未認証ユーザーロールの関連付け
  - _要件: 3.4_

- [x] 6. ストレージモジュールの実装
- [x] 6.1 S3バケットの作成と設定
  - 日本酒画像保存用S3バケットの作成
  - バージョニングの有効化
  - サーバーサイド暗号化（AES-256）の設定
  - _要件: 4.1, 4.2_

- [x] 6.2 S3バケットポリシーとCORS設定
  - パブリックアクセスブロックの設定
  - CORS設定（Webアプリケーション用）
  - IAMポリシー（事前署名URL生成用）の作成
  - _要件: 4.2, 4.3, 4.5_

- [x] 6.3 S3ライフサイクルポリシーの設定
  - 90日後にIA、365日後にGlacierへの移行設定
  - コスト最適化のためのライフサイクルルール
  - _要件: 4.4_

- [x] 7. データベースモジュールの実装
- [x] 7.1 DynamoDBテーブルの作成
  - DrinkingRecordsテーブルの作成
  - パーティションキー（userId）とソートキー（recordId）の設定
  - 保存時暗号化の有効化
  - _要件: 5.1, 5.2_

- [x] 7.2 DynamoDB Global Secondary Indexの作成
  - GSI1: sake_name-created_at-index（銘柄検索用）
  - GSI2: rating-created_at-index（評価検索用）
  - _要件: 5.4_

- [x] 7.3 DynamoDBバックアップとポイントインタイム復旧の設定
  - ポイントインタイム復旧の有効化（35日間）
  - オンデマンドバックアップの設定
  - _要件: 5.3_

- [x] 8. 監視モジュールの実装
- [x] 8.1 CloudWatchロググループの作成
  - ECSアプリケーションログ用ロググループ
  - ALBアクセスログ用ロググループ
  - VPCフローログ用ロググループ
  - ログ保持期間30日の設定
  - _要件: 6.1, 6.3, 6.5_

- [x] 8.2 CloudWatchアラームの設定
  - ECSタスクCPU使用率アラーム（閾値80%）
  - ECSタスクメモリ使用率アラーム（閾値80%）
  - ALBレスポンス時間アラーム（閾値3秒）
  - DynamoDB読み書きエラー率アラーム
  - _要件: 6.2_

- [x] 8.3 SNSトピックとアラート通知の設定
  - アラート通知用SNSトピックの作成
  - CloudWatchアラームとSNSトピックの連携
  - _要件: 6.4_

- [x] 9. 出力値とドキュメントの作成
- [x] 9.1 Terraform出力値の定義
  - VPC ID、サブネット ID
  - ALB DNS名、ターゲットグループ ARN
  - ECSクラスター名、サービス名
  - Cognito設定値（ユーザープールID、クライアントID）
  - S3バケット名、DynamoDBテーブル名
  - _要件: 1.5, 3.5_

- [x] 9.2 環境変数設定ドキュメントの作成
  - ECSタスク定義用環境変数リスト
  - Next.jsアプリケーション設定ガイド
  - デプロイ手順書の作成
  - _要件: 7.5_

- [x] 9.3 Terraformコードのテスト
  - terraform validateによる構文チェック
  - terraform planによる実行計画確認
  - セキュリティベストプラクティスの検証
  - _要件: 7.1, 7.2_

- [x] 10. 統合とデプロイ準備
- [x] 10.1 モジュール間の依存関係設定
  - モジュール間のデータ受け渡し設定
  - 適切な依存関係（depends_on）の設定
  - _要件: 7.1_

- [x] 10.2 Terraform状態管理の設定
  - S3バックエンド設定（状態ファイル保存用）
  - DynamoDBテーブル設定（状態ロック用）
  - _要件: 7.4_

- [x] 10.3 最終的な統合テストと検証
  - 全モジュールの統合実行
  - リソース作成の確認
  - セキュリティ設定の検証
  - コスト見積もりの確認
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_
