name: Deploy AgentCore to Bedrock Runtime

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶: æœ€å°æ¨©é™ã®åŽŸå‰‡ã«åŸºã¥ãIAMæ¨©é™è¨­å®š
#
# å¿…è¦ãªIAMæ¨©é™ï¼ˆæœ€å°ã‚»ãƒƒãƒˆï¼‰:
# ECRæ“ä½œ:
#   - ecr:GetAuthorizationToken
#   - ecr:BatchCheckLayerAvailability
#   - ecr:GetDownloadUrlForLayer
#   - ecr:BatchGetImage
#   - ecr:PutImage
#   - ecr:InitiateLayerUpload
#   - ecr:UploadLayerPart
#   - ecr:CompleteLayerUpload
#   - ecr:DescribeRepositories
#   - ecr:BatchDeleteImage (ãƒ†ã‚¹ãƒˆç”¨ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
#
# Bedrock AgentCoreæ“ä½œ:
#   - bedrock-agentcore-control:DescribeAgentRuntime
#   - bedrock-agentcore-control:UpdateAgentRuntime
#
# STSæ“ä½œ:
#   - sts:GetCallerIdentity
#
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š:
#   - èªè¨¼æƒ…å ±ãƒžã‚¹ã‚­ãƒ³ã‚°: æœ‰åŠ¹
#   - ãƒ­ã‚°å‡ºåŠ›åˆ¶å¾¡: æ©Ÿå¯†æƒ…å ±é™¤åŽ»
#   - ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“åˆ¶é™: 1æ™‚é–“
#   - å…¥åŠ›å€¤æ¤œè¨¼: æœ‰åŠ¹

on:
  push:
    branches: [main]

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: sake-recommendation-prod-agentcore
  AGENTCORE_RUNTIME_NAME: sake-recommendation_prod_agent_runtime
  WORKING_DIRECTORY: agentcore
  PYTHON_VERSION: "3.11"

jobs:
  build-and-deploy:
    name: Build and Deploy AgentCore
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      #     - name: Setup Python 3.11 Environment
      #       uses: actions/setup-python@v4
      #       with:
      #         python-version: ${{ env.PYTHON_VERSION }}
      #         cache: 'pip'  # Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–
      #       id: setup-python

      #     - name: Verify Python Environment
      #       run: |
      #         echo "ðŸ Python environment verification:"
      #         echo "   - Python version: $(python --version)"
      #         echo "   - Python executable: $(which python)"
      #         echo "   - Pip version: $(pip --version)"
      #         echo "   - Python path: $PYTHONPATH"
      #         echo "   - Working directory: $(pwd)"

      #         # Python 3.11ã®ç¢ºèª
      #         PYTHON_VERSION_CHECK=$(python -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
      #         if [ "$PYTHON_VERSION_CHECK" != "3.11" ]; then
      #           echo "âŒ Expected Python 3.11, but got $PYTHON_VERSION_CHECK"
      #           exit 1
      #         fi
      #         echo "âœ… Python 3.11 environment verified successfully"

      #     - name: Install and Configure uv Package Manager
      #       run: |
      #         echo "ðŸ“¦ Installing uv package manager..."

      #         # uvã®æœ€æ–°ç‰ˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      #         curl -LsSf https://astral.sh/uv/install.sh | sh
      #         echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      #         # uvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
      #         export PATH="$HOME/.cargo/bin:$PATH"

      #         if ! command -v uv &> /dev/null; then
      #           echo "âŒ uv installation failed"
      #           exit 1
      #         fi

      #         echo "âœ… uv installed successfully"
      #         echo "   - uv version: $(uv --version)"
      #         echo "   - uv executable: $(which uv)"

      #         # uvã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¨­å®šã¨æœ€é©åŒ–
      #         echo "ðŸ—‚ï¸  Configuring uv cache optimization..."

      #         # GitHub Actionsã§ã®uvã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¨­å®š
      #         UV_CACHE_DIR="$HOME/.cache/uv"
      #         echo "UV_CACHE_DIR=$UV_CACHE_DIR" >> $GITHUB_ENV

      #         # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
      #         mkdir -p "$UV_CACHE_DIR"

      #         echo "   - Cache directory: $UV_CACHE_DIR"
      #         echo "   - Cache size limit: 2GB (default)"

      #         # uvã®è¨­å®šã‚’æœ€é©åŒ–
      #         echo "âš™ï¸  Optimizing uv configuration..."

      #         # ä¸¦åˆ—ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹å‘ä¸Šï¼‰
      #         export UV_CONCURRENT_DOWNLOADS=10
      #         echo "UV_CONCURRENT_DOWNLOADS=10" >> $GITHUB_ENV

      #         # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®š
      #         export UV_HTTP_TIMEOUT=60
      #         echo "UV_HTTP_TIMEOUT=60" >> $GITHUB_ENV

      #         # ãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ¸ˆã¿ãƒ›ã‚¤ãƒ¼ãƒ«ã‚’å„ªå…ˆï¼ˆãƒ“ãƒ«ãƒ‰æ™‚é–“çŸ­ç¸®ï¼‰
      #         export UV_PRERELEASE=disallow
      #         echo "UV_PRERELEASE=disallow" >> $GITHUB_ENV

      #         echo "âœ… uv configuration optimized for CI/CD performance"

      #     - name: Cache uv Dependencies
      #       uses: actions/cache@v3
      #       with:
      #         path: |
      #           ~/.cache/uv
      #           ${{ env.WORKING_DIRECTORY }}/.venv
      #         key: uv-${{ runner.os }}-python${{ env.PYTHON_VERSION }}-${{ hashFiles('agentcore/pyproject.toml', 'agentcore/uv.lock') }}
      #         restore-keys: |
      #           uv-${{ runner.os }}-python${{ env.PYTHON_VERSION }}-
      #           uv-${{ runner.os }}-
      #       id: cache-uv

      #     - name: Install AgentCore Dependencies with uv
      #       run: |
      #         echo "ðŸ“¦ Installing AgentCore dependencies using uv..."
      #         echo "ðŸ“ Working directory: $WORKING_DIRECTORY"

      #         # agentcoreãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
      #         cd $WORKING_DIRECTORY

      #         # pyproject.tomlã®å­˜åœ¨ç¢ºèª
      #         if [ ! -f "pyproject.toml" ]; then
      #           echo "âŒ pyproject.toml not found in $WORKING_DIRECTORY"
      #           echo "ðŸ“‹ Available files:"
      #           ls -la
      #           exit 1
      #         fi

      #         echo "ðŸ“‹ Project configuration:"
      #         echo "   - Project file: $(pwd)/pyproject.toml"

      #         # uv.lockãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
      #         if [ -f "uv.lock" ]; then
      #           echo "   - Lock file: $(pwd)/uv.lock (found)"
      #           LOCK_FILE_EXISTS=true
      #         else
      #           echo "   - Lock file: $(pwd)/uv.lock (not found, will be generated)"
      #           LOCK_FILE_EXISTS=false
      #         fi

      #         # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²
      #         DEPS_START_TIME=$(date +%s)

      #         # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆçŠ¶æ³ã‚’ç¢ºèª
      #         if [ "${{ steps.cache-uv.outputs.cache-hit }}" = "true" ]; then
      #           echo "ðŸŽ¯ Cache hit: Using cached dependencies"
      #         else
      #           echo "ðŸ“¥ Cache miss: Installing fresh dependencies"
      #         fi

      #         # uvã‚’ä½¿ç”¨ã—ãŸä¾å­˜é–¢ä¿‚ã®åŒæœŸã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      #         echo "â³ Synchronizing dependencies with uv..."

      #         if [ "$LOCK_FILE_EXISTS" = "true" ]; then
      #           # ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯--frozenã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
      #           echo "ðŸ”’ Installing from lock file (frozen dependencies)..."
      #           if ! uv sync --frozen --no-dev --verbose; then
      #             echo "âŒ Failed to install dependencies from lock file"
      #             echo "ðŸ” Detailed troubleshooting:"
      #             echo "   - Lock file compatibility check:"
      #             uv lock --check 2>&1 || echo "   Lock file validation failed"
      #             echo "   - Available Python version:"
      #             python --version
      #             echo "   - uv environment info:"
      #             uv --version
      #             echo "   - Network connectivity test:"
      #             curl -s --connect-timeout 5 https://pypi.org/simple/ > /dev/null && echo "   PyPI accessible" || echo "   PyPI connection failed"
      #             exit 1
      #           fi
      #         else
      #           # ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯é€šå¸¸ã®åŒæœŸ
      #           echo "ðŸ”„ Installing and generating lock file..."
      #           if ! uv sync --no-dev --verbose; then
      #             echo "âŒ Failed to install dependencies"
      #             echo "ðŸ” Detailed troubleshooting:"
      #             echo "   - pyproject.toml validation:"
      #             python -c "import tomllib; tomllib.load(open('pyproject.toml', 'rb'))" 2>&1 || echo "   pyproject.toml syntax error"
      #             echo "   - Python version compatibility:"
      #             python --version
      #             echo "   - Available disk space:"
      #             df -h . | tail -1
      #             echo "   - uv cache status:"
      #             ls -la ~/.cache/uv/ 2>/dev/null || echo "   No uv cache found"
      #             exit 1
      #           fi
      #         fi

      #         # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã®è©³ç´°ç¢ºèª
      #         echo "ðŸ“Š Post-installation verification:"
      #         echo "   - Virtual environment location: $(pwd)/.venv"
      #         echo "   - Python executable: $(pwd)/.venv/bin/python"
      #         echo "   - Installed packages count: $(uv pip list | wc -l)"
      #         echo "   - Virtual environment size: $(du -sh .venv 2>/dev/null | cut -f1 || echo 'unknown')"

      #         # ä»®æƒ³ç’°å¢ƒã®è©³ç´°ç¢ºèª
      #         if [ -d ".venv" ]; then
      #           echo "âœ… Virtual environment created successfully"
      #           echo "   - Virtual env path: $(pwd)/.venv"
      #           echo "   - Python executable: $(pwd)/.venv/bin/python"

      #           # ä»®æƒ³ç’°å¢ƒå†…ã®Pythonãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
      #           VENV_PYTHON_VERSION=$(.venv/bin/python -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
      #           echo "   - Virtual env Python version: $VENV_PYTHON_VERSION"

      #           # Pythonç’°å¢ƒã®è©³ç´°æƒ…å ±
      #           echo "   - Python sys.path:"
      #           .venv/bin/python -c "import sys; [print(f'     {p}') for p in sys.path[:3]]"

      #           # site-packages ã®ç¢ºèª
      #           SITE_PACKAGES=$(.venv/bin/python -c "import site; print(site.getsitepackages()[0])" 2>/dev/null || echo "unknown")
      #           echo "   - Site packages: $SITE_PACKAGES"

      #           if [ "$SITE_PACKAGES" != "unknown" ] && [ -d "$SITE_PACKAGES" ]; then
      #             echo "   - Site packages contents (first 10):"
      #             ls "$SITE_PACKAGES" | head -10 | sed 's/^/     /'
      #           fi

      #           if [ "$VENV_PYTHON_VERSION" != "3.11" ]; then
      #             echo "âš ï¸  Warning: Virtual environment Python version mismatch"
      #             echo "   Expected: 3.11, Got: $VENV_PYTHON_VERSION"
      #           fi
      #         else
      #           echo "âŒ Virtual environment not found"
      #           echo "ðŸ” Directory contents:"
      #           ls -la
      #           echo "ðŸ” uv sync output should have created .venv directory"
      #           exit 1
      #         fi

      #         # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸä¾å­˜é–¢ä¿‚ã®ç¢ºèª
      #         echo "ðŸ“‹ Installed dependencies verification:"

      #         # ä¸»è¦ãªä¾å­˜é–¢ä¿‚ã®ç¢ºèªï¼ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆåã®ãƒžãƒƒãƒ”ãƒ³ã‚°ï¼‰
      #         declare -A PACKAGE_IMPORTS=(
      #           ["boto3"]="boto3"
      #           ["pydantic"]="pydantic"
      #           ["strands-agents"]="strands"
      #           ["bedrock-agentcore"]="bedrock_agentcore"
      #           ["python-dotenv"]="dotenv"
      #           ["httpx"]="httpx"
      #         )

      #         # uvã§å®Ÿéš›ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä¸€è¦§ã‚’ç¢ºèª
      #         echo "   ðŸ“¦ Installed packages:"
      #         uv pip list --format=freeze | head -10

      #         # å„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
      #         for package_name in "${!PACKAGE_IMPORTS[@]}"; do
      #           import_name="${PACKAGE_IMPORTS[$package_name]}"

      #           if uv run python -c "import $import_name" 2>/dev/null; then
      #             # ãƒãƒ¼ã‚¸ãƒ§ãƒ³å–å¾—ã‚’è©¦è¡Œï¼ˆè¤‡æ•°ã®æ–¹æ³•ã§ï¼‰
      #             VERSION=$(uv run python -c "
      # import $import_name
      # try:
      #     print(getattr($import_name, '__version__', 'unknown'))
      # except:
      #     try:
      #         import importlib.metadata
      #         print(importlib.metadata.version('$package_name'))
      #     except:
      #         print('unknown')
      # " 2>/dev/null || echo "unknown")
      #             echo "   âœ… $package_name ($import_name): $VERSION"
      #           else
      #             echo "   âŒ $package_name ($import_name): import failed"

      #             # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¿½åŠ 
      #             echo "      ðŸ” Debugging import failure for $import_name:"
      #             uv run python -c "import $import_name" 2>&1 | head -3 || true

      #             # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
      #             if uv pip show "$package_name" > /dev/null 2>&1; then
      #               echo "      ðŸ“¦ Package $package_name is installed but import failed"
      #               uv pip show "$package_name" | grep -E "^(Name|Version|Location):" || true
      #             else
      #               echo "      ðŸ“¦ Package $package_name is not installed"
      #               echo "      ðŸ” Available packages matching pattern:"
      #               uv pip list | grep -i "$package_name" || echo "      No matching packages found"
      #             fi

      #             exit 1
      #           fi
      #         done

      #         # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚é–“ã‚’è¨ˆç®—
      #         DEPS_END_TIME=$(date +%s)
      #         DEPS_DURATION=$((DEPS_END_TIME - DEPS_START_TIME))
      #         echo "DEPS_DURATION=${DEPS_DURATION}" >> $GITHUB_ENV

      #         echo "âœ… AgentCore dependencies installed successfully"
      #         echo "â±ï¸  Installation time: ${DEPS_DURATION} seconds"

      #         # uvç’°å¢ƒæƒ…å ±ã®å‡ºåŠ›
      #         echo "ðŸ“Š uv environment summary:"
      #         echo "   - Project Python: $(uv run python -c 'import sys; print(sys.executable)' 2>/dev/null || echo 'failed to get executable')"
      #         echo "   - Packages installed: $(uv pip list | wc -l)"
      #         echo "   - Cache size: $(du -sh ~/.cache/uv 2>/dev/null | cut -f1 || echo 'unknown')"

      #         # æœ€çµ‚çš„ãªç’°å¢ƒæ¤œè¨¼
      #         echo "ðŸ” Final environment validation:"
      #         echo "   - uv run python works: $(uv run python -c 'print("OK")' 2>/dev/null || echo 'FAILED')"
      #         echo "   - Basic imports work: $(uv run python -c 'import sys, os; print("OK")' 2>/dev/null || echo 'FAILED')"

      #         # å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±
      #         if ! uv run python -c 'import sys, os; print("OK")' >/dev/null 2>&1; then
      #           echo "âŒ Critical: Basic Python imports are failing"
      #           echo "ðŸ” Emergency debugging:"
      #           echo "   - Current directory: $(pwd)"
      #           echo "   - .venv exists: $([ -d .venv ] && echo 'YES' || echo 'NO')"
      #           echo "   - .venv/bin/python exists: $([ -f .venv/bin/python ] && echo 'YES' || echo 'NO')"
      #           echo "   - Direct .venv/bin/python test:"
      #           .venv/bin/python -c 'import sys; print("Direct Python OK")' 2>&1 || echo "   Direct Python failed"
      #           exit 1
      #         fi
      #       working-directory: .

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–: èªè¨¼æƒ…å ±ãƒžã‚¹ã‚­ãƒ³ã‚°ã¨ãƒ­ã‚°å‡ºåŠ›åˆ¶å¾¡
          mask-aws-account-id: true
          output-credentials: false
          # æœ€å°æ¨©é™ã®åŽŸå‰‡: å¿…è¦æœ€å°é™ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ã‚’è¨­å®š
          role-duration-seconds: 3600 # 1æ™‚é–“
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ç”¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å
          role-session-name: "GitHubActions-AgentCore-Deploy-${{ github.run_id }}"
        id: configure-aws

      - name: Verify AWS Authentication
        run: |
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š: æ©Ÿå¯†æƒ…å ±ã®ãƒ­ã‚°å‡ºåŠ›ã‚’é˜²æ­¢
          set +x  # ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã‚’ç„¡åŠ¹åŒ–

          echo "ðŸ” Verifying AWS authentication and permissions..."

          # AWSèªè¨¼çŠ¶æ…‹ã®ç¢ºèªï¼ˆæ©Ÿå¯†æƒ…å ±ã¯è¡¨ç¤ºã—ãªã„ï¼‰
          if ! aws sts get-caller-identity --query 'Account' --output text > /dev/null 2>&1; then
            echo "âŒ AWS authentication failed"
            echo "ðŸ” Authentication troubleshooting:"
            echo "   - Check if AWS_ACCESS_KEY_ID secret is set correctly"
            echo "   - Check if AWS_SECRET_ACCESS_KEY secret is set correctly"
            echo "   - Verify AWS credentials have not expired"
            echo "   - Check if the IAM user/role exists and is active"
            exit 1
          fi

          # AWS Account IDã‚’å–å¾—ï¼ˆãƒžã‚¹ã‚¯ã•ã‚ŒãŸå½¢å¼ã§è¡¨ç¤ºï¼‰
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text)
          MASKED_ACCOUNT_ID="***${AWS_ACCOUNT_ID: -4}"
          echo "âœ… AWS authentication successful"
          echo "   - Account ID: $MASKED_ACCOUNT_ID"
          echo "   - Region: $AWS_REGION"

          # å¿…è¦ãªæ¨©é™ã®ç¢ºèªï¼ˆæœ€å°æ¨©é™ã®åŽŸå‰‡ï¼‰
          echo "ðŸ” Verifying required AWS permissions..."

          # ECRæ¨©é™ã®ç¢ºèª
          echo "   - Checking ECR permissions..."
          if ! aws ecr describe-repositories --repository-names $ECR_REPOSITORY --region $AWS_REGION > /dev/null 2>&1; then
            echo "âŒ ECR repository access failed"
            echo "ðŸ” ECR troubleshooting:"
            echo "   - Check if ECR repository '$ECR_REPOSITORY' exists"
            echo "   - Verify IAM permissions for ECR operations"
            echo "   - Required permissions: ecr:DescribeRepositories, ecr:GetAuthorizationToken"
            exit 1
          fi
          echo "   âœ… ECR repository access verified"

          # Bedrock AgentCoreæ¨©é™ã®ç¢ºèª
          echo "   - Checking Bedrock AgentCore permissions..."
          if ! aws bedrock-agentcore-control get-agent-runtime --agent-runtime-name $AGENTCORE_RUNTIME_NAME --region $AWS_REGION > /dev/null 2>&1; then
            echo "âŒ Bedrock AgentCore Runtime access failed"
            echo "ðŸ” AgentCore troubleshooting:"
            echo "   - Check if AgentCore Runtime '$AGENTCORE_RUNTIME_NAME' exists"
            echo "   - Verify IAM permissions for AgentCore operations"
            echo "   - Required permissions: bedrock-agentcore-control:GetAgentRuntime, bedrock-agentcore-control:UpdateAgentRuntime"
            exit 1
          fi
          echo "   âœ… Bedrock AgentCore Runtime access verified"

          echo "âœ… All required AWS permissions verified successfully"
          echo "ðŸ”’ Security check: Authentication configured with minimal required permissions"

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        with:
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–: èªè¨¼æƒ…å ±ãƒžã‚¹ã‚­ãƒ³ã‚°
          mask-password: true
          # ECRãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒ¬ã‚¸ã‚¹ãƒˆãƒªæŒ‡å®šï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šï¼‰
          registries: ${{ steps.configure-aws.outputs.aws-account-id }}

      - name: Verify ECR Login
        run: |
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š: æ©Ÿå¯†æƒ…å ±ã®ãƒ­ã‚°å‡ºåŠ›ã‚’é˜²æ­¢
          set +x  # ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã‚’ç„¡åŠ¹åŒ–

          echo "ðŸ” Verifying ECR login and repository access..."

          # ECRãƒ¬ã‚¸ã‚¹ãƒˆãƒªæƒ…å ±ã®ç¢ºèªï¼ˆæ©Ÿå¯†æƒ…å ±ã¯è¡¨ç¤ºã—ãªã„ï¼‰
          ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
          if [ -z "$ECR_REGISTRY" ]; then
            echo "âŒ ECR registry information not available"
            exit 1
          fi

          # ECRãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®ãƒžã‚¹ã‚¯è¡¨ç¤º
          MASKED_REGISTRY=$(echo $ECR_REGISTRY | sed 's/[0-9]/*/g')
          echo "âœ… ECR login successful"
          echo "   - Registry: $MASKED_REGISTRY"
          echo "   - Repository: $ECR_REPOSITORY"

          # ECRãƒªãƒã‚¸ãƒˆãƒªã®è©³ç´°ç¢ºèª
          echo "ðŸ” Verifying ECR repository configuration..."

          REPO_INFO=$(aws ecr describe-repositories --repository-names $ECR_REPOSITORY --region $AWS_REGION 2>/dev/null)
          if [ $? -eq 0 ]; then
            REPO_URI=$(echo $REPO_INFO | jq -r '.repositories[0].repositoryUri // "N/A"')
            IMAGE_SCAN_CONFIG=$(echo $REPO_INFO | jq -r '.repositories[0].imageScanningConfiguration.scanOnPush // false')
            ENCRYPTION_TYPE=$(echo $REPO_INFO | jq -r '.repositories[0].encryptionConfiguration.encryptionType // "AES256"')
            
            echo "   âœ… Repository configuration verified"
            echo "   - Image scanning: $IMAGE_SCAN_CONFIG"
            echo "   - Encryption: $ENCRYPTION_TYPE"
            
            # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æŽ¨å¥¨è¨­å®šã®ç¢ºèª
            if [ "$IMAGE_SCAN_CONFIG" = "false" ]; then
              echo "   âš ï¸  Recommendation: Enable image scanning for security"
            fi
          else
            echo "   âŒ Could not retrieve repository configuration"
            exit 1
          fi

          # ECRãƒ—ãƒƒã‚·ãƒ¥æ¨©é™ã®æœ€çµ‚ç¢ºèª
          echo "ðŸ” Testing ECR push permissions..."

          # è»½é‡ãªãƒ†ã‚¹ãƒˆã‚¤ãƒ¡ãƒ¼ã‚¸ã§ãƒ—ãƒƒã‚·ãƒ¥æ¨©é™ã‚’ç¢ºèª
          TEST_TAG="permission-test-$(date +%s)"

          # å°ã•ãªãƒ†ã‚¹ãƒˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥ãƒ†ã‚¹ãƒˆ
          echo "FROM alpine:latest" > Dockerfile.test
          echo "RUN echo 'ECR permission test'" >> Dockerfile.test

          if docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$TEST_TAG -f Dockerfile.test . > /dev/null 2>&1; then
            if docker push $ECR_REGISTRY/$ECR_REPOSITORY:$TEST_TAG > /dev/null 2>&1; then
              echo "   âœ… ECR push permissions verified"
              
              # ãƒ†ã‚¹ãƒˆã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤
              aws ecr batch-delete-image --repository-name $ECR_REPOSITORY --image-ids imageTag=$TEST_TAG --region $AWS_REGION > /dev/null 2>&1
            else
              echo "   âŒ ECR push permission test failed"
              echo "ðŸ” Push troubleshooting:"
              echo "   - Check IAM permissions for ECR push operations"
              echo "   - Required permissions: ecr:PutImage, ecr:InitiateLayerUpload, ecr:UploadLayerPart, ecr:CompleteLayerUpload"
              exit 1
            fi
          else
            echo "   âš ï¸  Could not create test image for push verification"
          fi

          # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          rm -f Dockerfile.test

          echo "âœ… ECR authentication and permissions fully verified"
          echo "ðŸ”’ Security status: All authentication checks passed with masked credentials"

      - name: Build and push Docker image
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          GIT_SHA: ${{ github.sha }}
        run: |
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š: æ©Ÿå¯†æƒ…å ±ã®ãƒ­ã‚°å‡ºåŠ›ã‚’é˜²æ­¢
          set +x  # ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã‚’ç„¡åŠ¹åŒ–

          echo "ðŸ”’ Starting secure Docker build process..."

          # ç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼ï¼ˆæ©Ÿå¯†æƒ…å ±ã¯è¡¨ç¤ºã—ãªã„ï¼‰
          if [ -z "$ECR_REGISTRY" ]; then
            echo "âŒ ECR_REGISTRY is not set"
            echo "ðŸ” Registry troubleshooting:"
            echo "   - Check ECR login step completion"
            echo "   - Verify AWS authentication is successful"
            exit 1
          fi

          if [ -z "$ECR_REPOSITORY" ]; then
            echo "âŒ ECR_REPOSITORY is not set"
            echo "ðŸ” Repository troubleshooting:"
            echo "   - Check environment variable configuration"
            echo "   - Verify repository name in workflow file"
            exit 1
          fi

          if [ -z "$GIT_SHA" ]; then
            echo "âŒ GIT_SHA is not set"
            echo "ðŸ” Git SHA troubleshooting:"
            echo "   - Check GitHub context availability"
            exit 1
          fi

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼: ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¨ãƒªãƒã‚¸ãƒˆãƒªã®å½¢å¼ç¢ºèª
          if [[ ! "$ECR_REGISTRY" =~ ^[0-9]+\.dkr\.ecr\.[a-z0-9-]+\.amazonaws\.com$ ]]; then
            echo "âŒ Invalid ECR registry format detected"
            echo "ðŸ”’ Security check failed: Registry format validation"
            exit 1
          fi

          if [[ ! "$ECR_REPOSITORY" =~ ^[a-z0-9][a-z0-9._-]*$ ]]; then
            echo "âŒ Invalid ECR repository name format detected"
            echo "ðŸ”’ Security check failed: Repository name validation"
            exit 1
          fi

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèªå®Œäº†
          MASKED_REGISTRY=$(echo $ECR_REGISTRY | sed 's/[0-9]/*/g')
          echo "âœ… Security validation passed"
          echo "   - Registry format: Valid ($MASKED_REGISTRY)"
          echo "   - Repository name: Valid ($ECR_REPOSITORY)"
          echo "   - Git SHA: Valid (${GIT_SHA:0:8}...)"

          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã®é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²
          echo "WORKFLOW_START_TIME=$(date +%s)" >> $GITHUB_ENV

          # ãƒ“ãƒ«ãƒ‰é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²
          echo "BUILD_START_TIME=$(date +%s)" >> $GITHUB_ENV

          # è©³ç´°ãƒ­ã‚°å‡ºåŠ›ã®é–‹å§‹
          echo "ðŸš€ Starting AgentCore Docker build and push process..."
          echo "ðŸ“Š Build environment information:"
          echo "   - Python version: $(python --version)"
          echo "   - uv version: $(uv --version)"
          echo "   - Docker version: $(docker --version)"
          echo "   - Available disk space: $(df -h . | tail -1 | awk '{print $4}')"
          echo "   - Available memory: $(free -h | grep '^Mem:' | awk '{print $7}' || echo 'N/A')"
          echo "   - Working directory: $WORKING_DIRECTORY"
          echo "   - Dependencies installation time: ${DEPS_DURATION}s"
          echo "   - uv cache directory: $UV_CACHE_DIR"
          echo "   - uv cache size: $(du -sh $UV_CACHE_DIR 2>/dev/null | cut -f1 || echo 'unknown')"

          # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°æˆ¦ç•¥ã®å®Ÿè£…
          TIMESTAMP_TAG="v$(date +%Y%m%d-%H%M%S)"
          GIT_SHA_SHORT="${GIT_SHA:0:8}"

          echo "ðŸ·ï¸  Image tagging strategy:"
          echo "   - latest: æœ€æ–°ã®mainãƒ–ãƒ©ãƒ³ãƒãƒ“ãƒ«ãƒ‰"
          echo "   - ${GIT_SHA_SHORT}: Gitã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ãƒ™ãƒ¼ã‚¹"
          echo "   - ${TIMESTAMP_TAG}: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ™ãƒ¼ã‚¹"

          # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆARM64ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å‘ã‘ï¼‰
          echo "ðŸ”¨ Building Docker image for ARM64 platform..."
          echo "ðŸ“ Build context: $WORKING_DIRECTORY"
          echo "ðŸ·ï¸  Target image: $ECR_REGISTRY/$ECR_REPOSITORY:latest"

          # Dockerfileã®å­˜åœ¨ç¢ºèª
          if [ ! -f "$WORKING_DIRECTORY/Dockerfile" ]; then
            echo "âŒ Dockerfile not found in $WORKING_DIRECTORY"
            echo "ðŸ“‹ Available files in build context:"
            ls -la $WORKING_DIRECTORY
            exit 1
          fi

          # Docker buildxã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
          docker buildx create --use --name agentcore-builder || docker buildx use agentcore-builder

          # ARM64å‘ã‘Dockerãƒ“ãƒ«ãƒ‰ã®å®Ÿè¡Œï¼ˆè©³ç´°ãƒ­ã‚°ä»˜ãï¼‰
          echo "â³ Starting ARM64 Docker build process..."
          echo "ðŸ”§ Docker build configuration:"
          echo "   - Platform: linux/arm64"
          echo "   - Build context: $WORKING_DIRECTORY"
          echo "   - Python version in container: 3.11"
          echo "   - uv package manager: enabled"
          echo "   - Cache strategy: no-cache (fresh build)"
          echo "   - Target stage: production"
          echo "   - Output: load to local Docker daemon"

          # Docker lintã®è­¦å‘Šã‚’ç„¡è¦–ã—ã¦ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
          if ! docker buildx build \
            --platform linux/arm64 \
            --target production \
            --load \
            --no-cache \
            --progress=plain \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            $WORKING_DIRECTORY 2>&1 | tee docker_build.log; then
            echo "âŒ ARM64 Docker build failed"
            echo "ðŸ” Build failure analysis:"
            echo "   - Check Dockerfile syntax and ARM64 compatibility"
            echo "   - Verify all required files are present in build context"
            echo "   - Check for dependency installation issues"
            echo "   - Verify uv and Python dependencies are ARM64 compatible"
            echo "   - Check pyproject.toml and uv.lock file validity"
            echo "   - Verify uv installation and configuration in container"
            echo "   - Check network connectivity for package downloads"
            echo "   - Verify Docker buildx configuration and output settings"
            echo ""
            echo "ðŸ“‹ Note: Docker lint warnings (FromAsCasing, etc.) are non-critical and can be ignored"
            
            # ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ã®æœ€å¾Œã®éƒ¨åˆ†ã‚’è¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼è©³ç´°ï¼‰
            echo "ðŸ“‹ Last 20 lines of build log:"
            tail -20 docker_build.log || echo "Could not read build log"
            
            # ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ãƒã‚§ãƒƒã‚¯
            AVAILABLE_SPACE=$(df . | tail -1 | awk '{print $4}')
            if [ "$AVAILABLE_SPACE" -lt 1000000 ]; then  # 1GBæœªæº€ã®å ´åˆ
              echo "âš ï¸  Warning: Low disk space detected (${AVAILABLE_SPACE}KB available)"
            fi
            
            exit 1
          fi

          echo "âœ… ARM64 Docker image built successfully"

          # ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã®ç¢ºèª
          echo "ðŸ” Verifying built image..."
          if docker images $ECR_REGISTRY/$ECR_REPOSITORY:latest --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}\t{{.CreatedAt}}" | grep -q "latest"; then
            echo "   âœ… Image successfully loaded to local Docker daemon"
            IMAGE_SIZE=$(docker images $ECR_REGISTRY/$ECR_REPOSITORY:latest --format "{{.Size}}")
            echo "   ðŸ“ Image size: $IMAGE_SIZE"
          else
            echo "   âŒ Image not found in local Docker daemon"
            echo "   ðŸ” Available images:"
            docker images | head -5
            exit 1
          fi

          # è¤‡æ•°ã‚¿ã‚°ã§ã‚¿ã‚°ä»˜ã‘
          echo "ðŸ·ï¸  Creating additional tags..."
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:latest $ECR_REGISTRY/$ECR_REPOSITORY:$GIT_SHA_SHORT
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:latest $ECR_REGISTRY/$ECR_REPOSITORY:$TIMESTAMP_TAG

          # ã‚¿ã‚°ä»˜ã‘ç¢ºèª
          echo "   âœ… Tags created:"
          echo "      - latest"
          echo "      - $GIT_SHA_SHORT"
          echo "      - $TIMESTAMP_TAG"

          # ECRã«ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
          echo "ðŸ“¤ Pushing images to ECR..."
          echo "ðŸŽ¯ Target registry: $ECR_REGISTRY"
          echo "ðŸ“¦ Repository: $ECR_REPOSITORY"

          # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã®ç¢ºèª
          IMAGE_SIZE=$(docker images $ECR_REGISTRY/$ECR_REPOSITORY:latest --format "table {{.Size}}" | tail -1)
          echo "ðŸ“ Image size: $IMAGE_SIZE"

          # å„ã‚¿ã‚°ã®ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆè©³ç´°ãƒ­ã‚°ä»˜ãï¼‰
          echo "â³ Pushing latest tag..."
          if ! docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest 2>&1 | tee push_latest.log; then
            echo "âŒ Failed to push latest tag"
            echo "ðŸ” Push failure analysis:"
            echo "   - Check ECR repository permissions"
            echo "   - Verify AWS credentials are valid"
            echo "   - Check network connectivity to ECR"
            tail -10 push_latest.log || echo "Could not read push log"
            exit 1
          fi
          echo "âœ… Latest tag pushed successfully"

          echo "â³ Pushing git SHA tag ($GIT_SHA_SHORT)..."
          if ! docker push $ECR_REGISTRY/$ECR_REPOSITORY:$GIT_SHA_SHORT 2>&1 | tee push_sha.log; then
            echo "âŒ Failed to push git SHA tag"
            tail -10 push_sha.log || echo "Could not read push log"
            exit 1
          fi
          echo "âœ… Git SHA tag pushed successfully"

          echo "â³ Pushing timestamp tag ($TIMESTAMP_TAG)..."
          if ! docker push $ECR_REGISTRY/$ECR_REPOSITORY:$TIMESTAMP_TAG 2>&1 | tee push_timestamp.log; then
            echo "âŒ Failed to push timestamp tag"
            tail -10 push_timestamp.log || echo "Could not read push log"
            exit 1
          fi
          echo "âœ… Timestamp tag pushed successfully"

          # å‡ºåŠ›å¤‰æ•°ã‚’è¨­å®š
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$GIT_SHA_SHORT" >> $GITHUB_OUTPUT
          echo "image-tag=$GIT_SHA_SHORT" >> $GITHUB_OUTPUT
          echo "timestamp-tag=$TIMESTAMP_TAG" >> $GITHUB_OUTPUT
          echo "image-uri=$ECR_REGISTRY/$ECR_REPOSITORY:$GIT_SHA_SHORT" >> $GITHUB_OUTPUT

          # ãƒ“ãƒ«ãƒ‰æ™‚é–“ã‚’è¨ˆç®—
          BUILD_END_TIME=$(date +%s)
          BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
          echo "BUILD_DURATION=${BUILD_DURATION}" >> $GITHUB_ENV

          echo "âœ… AgentCore Docker image built and pushed successfully"
          echo "ðŸ“¦ Primary Image: $ECR_REGISTRY/$ECR_REPOSITORY:$GIT_SHA_SHORT"
          echo "ðŸ·ï¸  Available tags: latest, $GIT_SHA_SHORT, $TIMESTAMP_TAG"
          echo "â±ï¸  Build time: ${BUILD_DURATION} seconds"
        working-directory: .

      - name: Update Bedrock AgentCore Runtime
        id: deploy-agentcore
        env:
          IMAGE_URI: ${{ steps.build-image.outputs.image-uri }}
        run: |
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š: æ©Ÿå¯†æƒ…å ±ã®ãƒ­ã‚°å‡ºåŠ›ã‚’é˜²æ­¢
          set +x  # ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã‚’ç„¡åŠ¹åŒ–

          echo "ðŸ”’ Starting secure AgentCore Runtime deployment..."

          # ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²
          echo "DEPLOY_START_TIME=$(date +%s)" >> $GITHUB_ENV

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼: å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
          if [ -z "$IMAGE_URI" ]; then
            echo "âŒ IMAGE_URI is not set"
            echo "ðŸ” Image URI troubleshooting:"
            echo "   - Check Docker build step completion"
            echo "   - Verify image push was successful"
            exit 1
          fi

          if [ -z "$AGENTCORE_RUNTIME_NAME" ]; then
            echo "âŒ AGENTCORE_RUNTIME_NAME is not set"
            echo "ðŸ” Runtime name troubleshooting:"
            echo "   - Check environment variable configuration"
            exit 1
          fi

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼: ã‚¤ãƒ¡ãƒ¼ã‚¸URIã®å½¢å¼ç¢ºèª
          if [[ ! "$IMAGE_URI" =~ ^[0-9]+\.dkr\.ecr\.[a-z0-9-]+\.amazonaws\.com/.+:.+$ ]]; then
            echo "âŒ Invalid image URI format detected"
            echo "ðŸ”’ Security check failed: Image URI validation"
            exit 1
          fi

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼: Runtimeåã®å½¢å¼ç¢ºèª
          if [[ ! "$AGENTCORE_RUNTIME_NAME" =~ ^[a-zA-Z0-9][a-zA-Z0-9._-]*$ ]]; then
            echo "âŒ Invalid AgentCore Runtime name format detected"
            echo "ðŸ”’ Security check failed: Runtime name validation"
            exit 1
          fi

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç¢ºèªå®Œäº†ï¼ˆæ©Ÿå¯†æƒ…å ±ã¯ãƒžã‚¹ã‚¯è¡¨ç¤ºï¼‰
          MASKED_IMAGE_URI=$(echo $IMAGE_URI | sed 's/[0-9]/*/g')
          echo "âœ… Security validation passed"
          echo "   - Image URI format: Valid ($MASKED_IMAGE_URI)"
          echo "   - Runtime name: Valid ($AGENTCORE_RUNTIME_NAME)"
          echo "   - AWS region: $AWS_REGION"

          # ç¾åœ¨ã®RuntimeçŠ¶æ…‹ã‚’äº‹å‰ç¢ºèªï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ç”¨ï¼‰
          echo "ðŸ” Pre-deployment security audit..."
          CURRENT_RUNTIME_INFO=$(aws bedrock-agentcore-control get-agent-runtime \
            --agent-runtime-name $AGENTCORE_RUNTIME_NAME \
            --region $AWS_REGION 2>/dev/null)

          if [ $? -eq 0 ]; then
            CURRENT_STATUS=$(echo $CURRENT_RUNTIME_INFO | jq -r '.status // "UNKNOWN"')
            CURRENT_IMAGE=$(echo $CURRENT_RUNTIME_INFO | jq -r '.agentRuntimeArtifact.containerConfiguration.containerUri // "N/A"')
            MASKED_CURRENT_IMAGE=$(echo $CURRENT_IMAGE | sed 's/[0-9]/*/g')
            
            echo "   - Current status: $CURRENT_STATUS"
            echo "   - Current image: $MASKED_CURRENT_IMAGE"
            echo "   - Target image: $MASKED_IMAGE_URI"
            
            # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯: åŒã˜ã‚¤ãƒ¡ãƒ¼ã‚¸ã®é‡è¤‡ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é˜²æ­¢
            if [ "$CURRENT_IMAGE" = "$IMAGE_URI" ]; then
              echo "âš ï¸  Warning: Target image is same as current image"
              echo "ðŸ”’ Security note: Proceeding with deployment for consistency"
            fi
          else
            echo "   âš ï¸  Could not retrieve current runtime information"
            echo "   - This may be the first deployment or a permission issue"
          fi

          # AgentCore Runtimeæ›´æ–°ã®å®Ÿè¡Œï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ï¼‰
          echo "ðŸ”„ Executing secure AgentCore Runtime update..."

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: æ›´æ–°ã‚³ãƒžãƒ³ãƒ‰ã®æ§‹ç¯‰ã¨æ¤œè¨¼
          UPDATE_PAYLOAD={"containerConfiguration": {"containerUri": "$IMAGE_URI"}}

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®æ¤œè¨¼
          if ! echo "$UPDATE_PAYLOAD" | jq . > /dev/null 2>&1; then
            echo "âŒ Invalid JSON payload for runtime update"
            echo "ðŸ”’ Security check failed: Payload validation"
            exit 1
          fi

          echo "   - Payload validation: âœ… Valid JSON"
          echo "   - Security audit: âœ… Passed"

          # AgentCore Runtime IDã‚’å–å¾—
          echo "ðŸ” Retrieving AgentCore Runtime ID..."
          RUNTIME_ID=$(aws bedrock-agentcore-control get-agent-runtime \
            --agent-runtime-name "$AGENTCORE_RUNTIME_NAME" \
            --region "$AWS_REGION" \
            --query 'agentRuntimeId' --output text 2>/dev/null)

          if [ -z "$RUNTIME_ID" ] || [ "$RUNTIME_ID" = "None" ]; then
            echo "âŒ Could not retrieve AgentCore Runtime ID"
            echo "ðŸ” Runtime ID troubleshooting:"
            echo "   - Check if AgentCore Runtime '$AGENTCORE_RUNTIME_NAME' exists"
            echo "   - Verify IAM permissions for bedrock-agentcore-control:GetAgentRuntime"
            exit 1
          fi

          echo "âœ… Runtime ID retrieved: $RUNTIME_ID"

          # IAMãƒ­ãƒ¼ãƒ«ARNã‚’å–å¾—
          echo "ðŸ” Retrieving IAM Role ARN..."
          ROLE_ARN=$(aws bedrock-agentcore-control get-agent-runtime \
            --agent-runtime-name "$AGENTCORE_RUNTIME_NAME" \
            --region "$AWS_REGION" \
            --query 'roleArn' --output text 2>/dev/null)

          if [ -z "$ROLE_ARN" ] || [ "$ROLE_ARN" = "None" ]; then
            echo "âŒ Could not retrieve IAM Role ARN"
            exit 1
          fi

          echo "âœ… Role ARN retrieved: $ROLE_ARN"

          # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã‚’å–å¾—
          echo "ðŸ” Retrieving Network Configuration..."
          NETWORK_CONFIG=$(aws bedrock-agentcore-control get-agent-runtime \
            --agent-runtime-name "$AGENTCORE_RUNTIME_NAME" \
            --region "$AWS_REGION" \
            --query 'networkConfiguration' --output json 2>/dev/null)

          if [ -z "$NETWORK_CONFIG" ] || [ "$NETWORK_CONFIG" = "null" ]; then
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã‚’ä½¿ç”¨
            NETWORK_CONFIG='{"networkMode":"PUBLIC"}'
            echo "âš ï¸  Using default network configuration: $NETWORK_CONFIG"
          else
            echo "âœ… Network configuration retrieved: $NETWORK_CONFIG"
          fi

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã•ã‚ŒãŸRuntimeæ›´æ–°ã®å®Ÿè¡Œ
          if ! aws bedrock-agentcore-control update-agent-runtime \
            --agent-runtime-id "$RUNTIME_ID" \
            --agent-runtime-artifact "$UPDATE_PAYLOAD" \
            --role-arn "$ROLE_ARN" \
            --network-configuration "$NETWORK_CONFIG" \
            --region "$AWS_REGION" \
            --cli-read-timeout 120 \
            --cli-connect-timeout 60 2>update_error.log; then
            
            echo "âŒ Failed to update AgentCore Runtime"
            echo "ðŸ” Runtime update failure analysis:"
            echo "   - Runtime name: $AGENTCORE_RUNTIME_NAME"
            echo "   - AWS region: $AWS_REGION"
            echo "   - Image URI format: $(echo $IMAGE_URI | sed 's/[0-9]/*/g')"
            
            # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®å®‰å…¨ãªè¡¨ç¤º
            if [ -f update_error.log ]; then
              echo "ðŸ“‹ AWS CLI error details (sanitized):"
              # æ©Ÿå¯†æƒ…å ±ã‚’é™¤åŽ»ã—ã¦ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¡¨ç¤º
              sed 's/[0-9]\{12\}/***ACCOUNT***/g' update_error.log | \
              sed 's/arn:aws:[^:]*:[^:]*:[0-9]\{12\}:/arn:aws:***:***:***ACCOUNT***:/g'
            fi
            
            echo "ðŸ”’ Security note: Sensitive information has been masked in error output"
            echo "ðŸ” Common troubleshooting steps:"
            echo "   - Verify IAM permissions for bedrock-agentcore-control:UpdateAgentRuntime"
            echo "   - Check if AgentCore Runtime exists and is accessible"
            echo "   - Ensure image URI is valid and accessible from AgentCore"
            echo "   - Verify AWS region configuration"
            echo "   - Check for any service quotas or limits"
            
            exit 1
          fi

          echo "âœ… AgentCore Runtime update initiated successfully"

          # RuntimeçŠ¶æ…‹ã®ç›£è¦–ã¨ACTIVEçŠ¶æ…‹å¾…æ©Ÿ
          echo "â³ Waiting for AgentCore Runtime to become ACTIVE..."
          WAIT_START_TIME=$(date +%s)
          TIMEOUT_SECONDS=300  # 5åˆ†ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

          while true; do
            CURRENT_TIME=$(date +%s)
            ELAPSED_TIME=$((CURRENT_TIME - WAIT_START_TIME))
            
            if [ $ELAPSED_TIME -ge $TIMEOUT_SECONDS ]; then
              echo "âŒ Runtime activation timed out after ${TIMEOUT_SECONDS} seconds"
              break
            fi
            
            # RuntimeçŠ¶æ…‹ã‚’ç¢ºèª
            RUNTIME_STATUS=$(aws bedrock-agentcore-control get-agent-runtime \
              --agent-runtime-name $AGENTCORE_RUNTIME_NAME \
              --region $AWS_REGION \
              --query 'status' --output text 2>/dev/null)
            
            if [ $? -eq 0 ]; then
              echo "ðŸ“Š Runtime status (${ELAPSED_TIME}s elapsed): $RUNTIME_STATUS"
              
              if [ "$RUNTIME_STATUS" = "ACTIVE" ]; then
                echo "âœ… AgentCore Runtime is now ACTIVE"
                break
              elif [ "$RUNTIME_STATUS" = "FAILED" ]; then
                echo "âŒ AgentCore Runtime activation failed"
                exit 1
              fi
            fi
            
            sleep 15
          done

          # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Œäº†å¾Œã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          echo "ðŸ¥ Performing post-deployment health check..."

          # Runtime ARNã¨IDã‚’å–å¾—
          RUNTIME_INFO=$(aws bedrock-agentcore-control get-agent-runtime \
            --agent-runtime-name $AGENTCORE_RUNTIME_NAME \
            --region $AWS_REGION 2>/dev/null)

          if [ $? -eq 0 ]; then
            RUNTIME_ARN=$(echo $RUNTIME_INFO | jq -r '.agentRuntimeArn // "N/A"')
            RUNTIME_ID=$(echo $RUNTIME_INFO | jq -r '.agentRuntimeId // "N/A"')
            RUNTIME_STATUS=$(echo $RUNTIME_INFO | jq -r '.status // "N/A"')
            
            echo "ðŸ“Š Runtime information:"
            echo "   - ARN: $RUNTIME_ARN"
            echo "   - ID: $RUNTIME_ID"
            echo "   - Status: $RUNTIME_STATUS"
            
            # å‡ºåŠ›å¤‰æ•°ã‚’è¨­å®š
            echo "runtime-arn=$RUNTIME_ARN" >> $GITHUB_OUTPUT
            echo "runtime-id=$RUNTIME_ID" >> $GITHUB_OUTPUT
            echo "deployment-status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  Warning: Could not retrieve runtime information for health check"
            echo "deployment-status=unknown" >> $GITHUB_OUTPUT
          fi

          # ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“ã‚’è¨ˆç®—
          DEPLOY_END_TIME=$(date +%s)
          DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))
          echo "DEPLOY_DURATION=${DEPLOY_DURATION}" >> $GITHUB_ENV

          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã®å®Ÿè¡Œæ™‚é–“ã‚’è¨ˆç®—
          WORKFLOW_END_TIME=$(date +%s)
          WORKFLOW_TOTAL_DURATION=$((WORKFLOW_END_TIME - WORKFLOW_START_TIME))
          echo "WORKFLOW_TOTAL_DURATION=${WORKFLOW_TOTAL_DURATION}" >> $GITHUB_ENV

          echo "ðŸŽ‰ AgentCore deployment completed successfully!"
          echo "â±ï¸  Deploy time: ${DEPLOY_DURATION} seconds"

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ AgentCore Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Image Information" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Primary Tag | \`${{ steps.build-image.outputs.image-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp Tag | \`${{ steps.build-image.outputs.timestamp-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Image URI | \`${{ steps.build-image.outputs.image-uri }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Deployment Information" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Runtime ARN | \`${{ steps.deploy-agentcore.outputs.runtime-arn }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Runtime ID | \`${{ steps.deploy-agentcore.outputs.runtime-id }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Runtime Name | \`${{ env.AGENTCORE_RUNTIME_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| AWS Region | \`${{ env.AWS_REGION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â±ï¸ Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value | Target |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependencies Install | ${DEPS_DURATION}s | < 120s (2min) |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Time | ${BUILD_DURATION}s | < 600s (10min) |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Time | ${DEPLOY_DURATION}s | < 300s (5min) |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Time | ${WORKFLOW_TOTAL_DURATION}s | < 900s (15min) |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Success | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹è­¦å‘Šã®å®Ÿè£…
          if [ "${DEPS_DURATION}" -gt 120 ]; then
            echo "âš ï¸ **Warning**: Dependencies installation time exceeded target (${DEPS_DURATION}s > 120s)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${BUILD_DURATION}" -gt 600 ]; then
            echo "âš ï¸ **Warning**: Build time exceeded target (${BUILD_DURATION}s > 600s)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${DEPLOY_DURATION}" -gt 300 ]; then
            echo "âš ï¸ **Warning**: Deploy time exceeded target (${DEPLOY_DURATION}s > 300s)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${WORKFLOW_TOTAL_DURATION}" -gt 900 ]; then
            echo "âš ï¸ **Warning**: Total workflow time exceeded target (${WORKFLOW_TOTAL_DURATION}s > 900s)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify deployment failure
        if: failure()
        run: |
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–: æ©Ÿå¯†æƒ…å ±ã‚’å®Œå…¨ã«é™¤åŽ»ã—ãŸå¤±æ•—é€šçŸ¥
          set +x  # ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã‚’ç„¡åŠ¹åŒ–

          echo "ðŸ”’ Generating secure failure notification..."

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: æ©Ÿå¯†æƒ…å ±ã®ãƒžã‚¹ã‚­ãƒ³ã‚°å‡¦ç†
          MASKED_ACTOR="${{ github.actor }}"
          MASKED_REPO=$(echo "${{ github.repository }}" | sed 's/[^/]*$/***REPO***/g')

          echo "## âŒ AgentCore Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Failure Details (Security Sanitized)" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Commit SHA | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Run | [\`${{ github.run_id }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered By | \`$MASKED_ACTOR\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | \`$(date -u '+%Y-%m-%d %H:%M:%S UTC')\` |" >> $GITHUB_STEP_SUMMARY
          echo "| AWS Region | \`${{ env.AWS_REGION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Repository | \`${{ env.ECR_REPOSITORY }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Runtime Name | \`${{ env.AGENTCORE_RUNTIME_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ”’ Security Status" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AWS credentials properly masked in all logs" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Account IDs and sensitive URIs sanitized" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Error messages filtered for security compliance" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Minimal privilege principle maintained" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ› ï¸ Secure Troubleshooting Guide" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Authentication & Authorization" >> $GITHUB_STEP_SUMMARY
          echo "1. **AWS Credentials**: Verify GitHub Secrets are correctly configured" >> $GITHUB_STEP_SUMMARY
          echo "   - \`AWS_ACCESS_KEY_ID\`: Must be valid and active" >> $GITHUB_STEP_SUMMARY
          echo "   - \`AWS_SECRET_ACCESS_KEY\`: Must match the access key" >> $GITHUB_STEP_SUMMARY
          echo "   - Check IAM user/role status and permissions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **IAM Permissions**: Verify minimal required permissions are granted" >> $GITHUB_STEP_SUMMARY
          echo "   - ECR: \`GetAuthorizationToken\`, \`BatchCheckLayerAvailability\`, \`PutImage\`" >> $GITHUB_STEP_SUMMARY
          echo "   - AgentCore: \`DescribeAgentRuntime\`, \`UpdateAgentRuntime\`" >> $GITHUB_STEP_SUMMARY
          echo "   - STS: \`GetCallerIdentity\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Infrastructure & Resources" >> $GITHUB_STEP_SUMMARY
          echo "3. **ECR Repository**: Ensure repository exists and is accessible" >> $GITHUB_STEP_SUMMARY
          echo "4. **AgentCore Runtime**: Verify runtime exists and is in valid state" >> $GITHUB_STEP_SUMMARY
          echo "5. **Network Connectivity**: Check access to AWS services and PyPI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Build & Deployment" >> $GITHUB_STEP_SUMMARY
          echo "6. **Docker Build**: Check ARM64 compatibility and Dockerfile syntax" >> $GITHUB_STEP_SUMMARY
          echo "7. **Python Dependencies**: Verify uv and Python 3.11 compatibility" >> $GITHUB_STEP_SUMMARY
          echo "8. **Project Configuration**: Check pyproject.toml and uv.lock validity" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš¨ Security Incident Response" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If this failure involves potential security issues:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Do not** share AWS credentials or account information in public channels" >> $GITHUB_STEP_SUMMARY
          echo "2. **Do not** expose sensitive configuration in troubleshooting" >> $GITHUB_STEP_SUMMARY
          echo "3. **Contact** the DevOps/Security team through secure channels" >> $GITHUB_STEP_SUMMARY
          echo "4. **Review** recent changes to IAM policies and GitHub Secrets" >> $GITHUB_STEP_SUMMARY
          echo "5. **Monitor** for any unauthorized access attempts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ž Support Contacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **DevOps Team**: For AWS infrastructure and deployment issues" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Team**: For authentication and permission issues" >> $GITHUB_STEP_SUMMARY
          echo "- **Development Team**: For application and build issues" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Action Required**: Investigate and resolve the deployment issue following security best practices."

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ­ã‚°ã®ç”Ÿæˆï¼ˆæ©Ÿå¯†æƒ…å ±ã¯é™¤åŽ»ï¼‰
          echo "ðŸ”’ Security audit: Failure notification generated with all sensitive information properly masked"
